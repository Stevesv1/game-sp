<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Star Quest - Bomb Survival</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(180deg, #0a0a23 0%, #1a1a3d 100%);
      font-family: 'Poppins', sans-serif;
      color: white;
    }
    #wallet-info {
      display: none; /* Hidden until wallet is connected */
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 1.1em;
    }
    #game-interface {
      text-align: center;
      padding: 20px;
    }
    #stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .stat-box {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      min-width: 120px; /* Increased width for better readability */
    }
    .stat-box h3 {
      margin: 0 0 10px 0;
      font-size: 1.3em;
    }
    .stat-box div {
      font-size: 1.5em;
    }
    .lives-container {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .life {
      width: 25px;
      height: 25px;
      background: url('https://img.icons8.com/emoji/48/heart-suit.png') no-repeat center;
      background-size: contain;
    }
    #game-container {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 15px;
      margin: 20px auto;
      max-width: 330px; /* Ensures grid stays compact */
    }
    .box {
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      cursor: pointer;
      position: relative;
      perspective: 1000px;
    }
    .flipper {
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .box.revealed .flipper {
      transform: rotateY(180deg);
    }
    .front, .back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2em;
      border-radius: 10px;
    }
    .front {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    .back {
      transform: rotateY(180deg);
    }
    .bomb {
      background: #ff4444;
    }
    .star {
      background: #ffd700;
    }
    .bomb-content, .star-content {
      font-size: 2em;
    }
    #button-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    button {
      padding: 12px 24px;
      font-size: 1.2em; /* Larger buttons for readability */
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .game-over {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 600px;
    }
    .game-over.show {
      display: block;
    }
    #rules-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      z-index: 1000;
    }
    #rules-modal h1 {
      font-size: 2em;
      margin-bottom: 20px;
    }
    #rules-modal ul {
      list-style-type: none;
      padding: 0;
      text-align: left;
      margin: 20px 0;
      font-size: 1.2em;
    }
    #rules-modal li {
      margin-bottom: 15px;
    }
    p {
      font-size: 1.3em; /* Larger text for better readability */
      margin: 15px 0;
    }
    h1 {
      font-size: 2.5em;
    }
    h3 {
      font-size: 1.5em;
    }
  </style>
</head>
<body>
  <div id="wallet-info">
    <div id="wallet-address">Not connected</div>
    <div id="wallet-balance">Balance: 0 ETH</div>
  </div>
  <div id="game-interface" style="display: none;">
    <div id="stats">
      <div class="stat-box">
        <h3>Stars</h3>
        <div id="stars">0</div>
      </div>
      <div class="stat-box">
        <h3>Lives</h3>
        <div class="lives-container" id="lives-container"></div>
      </div>
    </div>
    <div id="game-container"></div>
    <div id="button-container">
      <button id="sacrifice-btn">Sacrifice Life for 5★</button>
      <button id="cash-out-btn">Cash Out</button>
    </div>
  </div>
  <div class="game-over" id="game-over">
    <h1 id="game-over-title">Game Over!</h1>
    <button id="play-again-btn">Play Again</button>
    <button id="buy-lives-btn">Buy 5 Lives for 0.0005 ETH</button>
  </div>
  <div id="rules-modal" style="display: block;">
    <h1>Star Quest Rules</h1>
    <ul>
      <li>▫️ Connect your wallet and buy 5 lives for 0.0005 Sepolia ETH.</li>
      <li>▫️ Click boxes (cost 1 star) to find stars or bombs (2 bombs/9 boxes).</li>
      <li>▫️ Stars: Gain 1-10 stars randomly.</li>
      <li>▫️ Bombs: Lose a life and cycle stars.</li>
      <li>▫️ Reveal 7 safe boxes for 10 bonus stars and reset.</li>
      <li>▫️ Sacrifice a life for 5 stars if 0 stars (min 2 lives).</li>
      <li>▫️ Cash out anytime or lose all lives to end.</li>
      <li>▫️ Pay 0.0005 Sepolia ETH to buy 5 lives when lives run out.</li>
    </ul>
    <button id="start-game-btn">Start Game</button>
  </div>
  <audio id="bomb-sound" src="https://www.myinstants.com/media/sounds/explosion.mp3"></audio>
  <audio id="star-sound" src="https://www.myinstants.com/media/sounds/coin.mp3"></audio>

  <script>
    if (/Android|iPhone/i.test(navigator.userAgent)) {
      document.body.innerHTML = '<h1 style="color: white; text-align: center;">This game is only available on PC.</h1>';
    } else {
      let provider, signer, walletAddress, contract;
      let stars = 0, lives = 0, cycleStars = 0, gameActive = false;
      let bombPositions = [], revealedCount = 0;

      const contractAddress = "0x4919c7C59bDca44c60086e429877eE04Fe2da18F";
      const contractABI = [
        {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"lives","type":"uint256"}],"name":"LivesPurchased","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"lives","type":"uint256"}],"name":"LivesUpdated","type":"event"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"stars","type":"uint256"}],"name":"StarsUpdated","type":"event"},
        {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"players","outputs":[{"internalType":"uint256","name":"stars","type":"uint256"},{"internalType":"uint256","name":"lives","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"buyLives","outputs":[],"stateMutability":"payable","type":"function"},
        {"inputs":[{"internalType":"address","name":"player","type":"address"}],"name":"getPlayer","outputs":[{"internalType":"uint256","name":"stars","type":"uint256"},{"internalType":"uint256","name":"lives","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"lifeCost","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"livesPerPurchase","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"newLives","type":"uint256"}],"name":"updateLives","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"newStars","type":"uint256"}],"name":"updateStars","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}
      ];

      // Confetti settings for star celebration
      const defaults = {
        spread: 360,
        ticks: 50,
        gravity: 0,
        decay: 0.94,
        startVelocity: 30,
        colors: ['FFE400', 'FFBD00', 'E89400', 'FFCA6C', 'FDFFB8']
      };

      function shoot(origin) {
        confetti({ ...defaults, particleCount: 40, scalar: 1.2, shapes: ['star'], origin });
        confetti({ ...defaults, particleCount: 10, scalar: 0.75, shapes: ['circle'], origin });
      }

      function createCelebration(origin) {
        setTimeout(() => shoot(origin), 0);
        setTimeout(() => shoot(origin), 100);
        setTimeout(() => shoot(origin), 200);
      }

      async function connectWallet() {
        if (!window.ethereum) {
          alert("Please install MetaMask!");
          return false;
        }
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        walletAddress = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        const network = await provider.getNetwork();
        if (network.chainId !== 11155111) { // Sepolia chainId
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0xAA36A7' }],
            });
          } catch (error) {
            alert("Please switch to Sepolia network in MetaMask.");
            return false;
          }
        }
        document.getElementById('wallet-address').textContent = `Connected: ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`;
        await updateBalance();
        document.getElementById('wallet-info').style.display = 'block';
        return true;
      }

      async function updateBalance() {
        if (provider && walletAddress) {
          const balance = await provider.getBalance(walletAddress);
          document.getElementById('wallet-balance').textContent = `Balance: ${ethers.utils.formatEther(balance).slice(0, 6)} ETH`;
        }
      }

      async function buyLives() {
        if (!contract) {
          alert("Please connect your wallet first.");
          return;
        }
        try {
          const tx = await contract.buyLives({ value: ethers.utils.parseEther("0.0005") });
          await tx.wait();
          await loadUserData();
          document.getElementById('game-over').classList.remove('show');
          initializeGame();
        } catch (error) {
          console.error("Buy Lives Error:", error);
          alert("Failed to buy lives. Check your Sepolia ETH balance.");
        }
      }

      async function loadUserData() {
        if (contract && walletAddress) {
          const player = await contract.getPlayer(walletAddress);
          stars = Number(player.stars);
          lives = Number(player.lives);
          updateStarsDisplay(stars);
          renderLives();
        }
      }

      async function updateStars(newValue) {
        if (contract && walletAddress) {
          try {
            const tx = await contract.updateStars(walletAddress, newValue, { from: walletAddress });
            await tx.wait();
            stars = newValue;
            updateStarsDisplay(stars);
          } catch (error) {
            console.error("Update Stars Error:", error);
            throw error; // Let the caller handle the error
          }
        }
      }

      async function updateLives(newValue) {
        if (contract && walletAddress) {
          try {
            const tx = await contract.updateLives(walletAddress, newValue, { from: walletAddress });
            await tx.wait();
            lives = newValue;
            renderLives();
          } catch (error) {
            console.error("Update Lives Error:", error);
            throw error;
          }
        }
      }

      function updateStarsDisplay(value) {
        document.getElementById('stars').textContent = value;
      }

      function renderLives() {
        const livesContainer = document.getElementById('lives-container');
        livesContainer.innerHTML = '';
        for (let i = 0; i < lives; i++) {
          const life = document.createElement('div');
          life.className = 'life';
          livesContainer.appendChild(life);
        }
      }

      function initializeGame() {
        const gameContainer = document.getElementById('game-container');
        gameContainer.innerHTML = '';
        bombPositions = [];
        revealedCount = 0;
        cycleStars = 0;
        gameActive = lives > 0;

        if (!gameActive) {
          gameContainer.innerHTML = '<p>You have no lives left. Buy more to play.</p><button id="buy-lives-in-game">Buy 5 Lives</button>';
          document.getElementById('buy-lives-in-game').addEventListener('click', buyLives);
          return;
        }

        // Generate 2 random bomb positions
        while (bombPositions.length < 2) {
          const pos = Math.floor(Math.random() * 9);
          if (!bombPositions.includes(pos)) bombPositions.push(pos);
        }

        // Create 9 boxes
        for (let i = 0; i < 9; i++) {
          const box = document.createElement('div');
          box.className = 'box';
          box.dataset.index = i;
          box.innerHTML = '<div class="flipper"><div class="front">?</div><div class="back"></div></div>';
          box.addEventListener('click', handleBoxClick);
          gameContainer.appendChild(box);
        }
        console.log("Game initialized with", gameContainer.children.length, "boxes");
      }

      async function handleBoxClick(event) {
        if (!gameActive) {
          alert("Game is not active. Please start a new game.");
          return;
        }
        if (lives === 0) {
          alert("No lives left. Buy more to continue.");
          return;
        }
        if (stars < 1) {
          alert("You need at least 1 star to click a box. Sacrifice a life for 5 stars if you have enough lives.");
          return;
        }

        const box = event.target.closest('.box');
        if (!box || box.classList.contains('revealed')) return;

        const index = parseInt(box.dataset.index);
        console.log("Box clicked at index:", index);

        try {
          await updateStars(stars - 1); // Deduct 1 star for clicking
          box.classList.add('revealed');
          revealedCount++;

          const back = box.querySelector('.back');
          if (bombPositions.includes(index)) {
            back.innerHTML = '<div class="bomb-content">💣</div>';
            back.classList.add('bomb');
            document.getElementById('bomb-sound').play();
            await updateLives(lives - 1);
            await updateStars(stars - cycleStars);
            cycleStars = 0;

            if (lives === 0) {
              gameActive = false;
              showGameOver('no_lives');
            } else {
              setTimeout(initializeGame, 1500);
            }
          } else {
            const rect = box.getBoundingClientRect();
            const origin = {
              x: (rect.left + rect.width / 2) / window.innerWidth,
              y: (rect.top + rect.height / 2) / window.innerHeight
            };
            createCelebration(origin);
            const gainedStars = Math.floor(Math.random() * 10) + 1;
            cycleStars += gainedStars;
            await updateStars(stars + gainedStars);
            back.innerHTML = `<div class="star-content">${gainedStars}</div>`;
            back.classList.add('star');
            document.getElementById('star-sound').play();

            if (revealedCount === 7) {
              const bonusStars = 10;
              cycleStars += bonusStars;
              await updateStars(stars + bonusStars);
              initializeGame();
            }
          }
        } catch (error) {
          console.error("Box click error:", error);
          alert("An error occurred. Check the console for details.");
        }
      }

      function showGameOver(reason) {
        const gameOver = document.getElementById('game-over');
        const title = document.getElementById('game-over-title');
        const playAgainBtn = document.getElementById('play-again-btn');
        const buyLivesBtn = document.getElementById('buy-lives-btn');

        gameOver.classList.add('show');
        if (reason === 'no_lives') {
          title.textContent = 'No Lives Left!';
          playAgainBtn.style.display = 'none';
          buyLivesBtn.style.display = 'block';
        } else if (reason === 'cashed_out') {
          title.textContent = `Cashed Out with ${stars} Stars!`;
          playAgainBtn.style.display = 'block';
          buyLivesBtn.style.display = 'none';
        }
      }

      document.getElementById('sacrifice-btn').addEventListener('click', async () => {
        if (lives < 2) {
          alert("You need at least 2 lives to sacrifice one for stars.");
          return;
        }
        try {
          await updateLives(lives - 1);
          await updateStars(stars + 5);
        } catch (error) {
          alert("Failed to sacrifice life. Check console for details.");
        }
      });

      document.getElementById('cash-out-btn').addEventListener('click', () => {
        if (gameActive) {
          gameActive = false;
          showGameOver('cashed_out');
          createCelebration({ x: 0.5, y: 0.5 });
        }
      });

      document.getElementById('play-again-btn').addEventListener('click', () => {
        document.getElementById('game-over').classList.remove('show');
        if (lives > 0) initializeGame();
        else alert("No lives left. Buy more to play.");
      });

      document.getElementById('buy-lives-btn').addEventListener('click', buyLives);

      document.getElementById('start-game-btn').addEventListener('click', async () => {
        if (await connectWallet()) {
          document.getElementById('rules-modal').style.display = 'none';
          document.getElementById('game-interface').style.display = 'block';
          await loadUserData();
          initializeGame();
        }
      });
    }
  </script>
</body>
</html>
